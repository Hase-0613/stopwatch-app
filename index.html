
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>å…±æœ‰ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒï¼ˆç®¡ç†è€…åˆ¶é™ä»˜ãï¼‰</title>
  <style>
/* Google Fontsã‹ã‚‰ãƒ•ã‚©ãƒ³ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ */
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Roboto+Mono:wght@500&display=swap');

body {
    /* ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
    font-family: 'Noto Sans JP', sans-serif;
    text-align: center;
    
    /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã®é…è‰² */
    background-color: #1a1a1a;
    color: #f0f0f0;

    /* ã‚¹ãƒ ãƒ¼ã‚ºãªè‰²ã®å¤‰åŒ– */
    transition: background-color 0.3s, color 0.3s;
    
    /* ä¸Šä¸‹ã®ä½™ç™½ã‚’èª¿æ•´ */
    margin: 0;
    padding: 40px 15px;
}

/* ã‚¢ãƒ—ãƒªå…¨ä½“ã‚’å›²ã‚€ã‚³ãƒ³ãƒ†ãƒŠ */
.stopwatch-container {
    max-width: 500px;
    margin: auto;
    background-color: #2c2c2c;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

h2 {
    font-size: 28px;
    color: #66ccff; /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ */
    margin-bottom: 30px;
}

.clock {
    font-family: 'Roboto Mono', monospace; /* æ•°å­—ç”¨ã®ç­‰å¹…ãƒ•ã‚©ãƒ³ãƒˆ */
    font-size: 48px; /* ã‚µã‚¤ã‚ºã‚’å¤§ããã—ã¦è¦–èªæ€§ã‚¢ãƒƒãƒ— */
    margin: 15px 0;
    letter-spacing: 2px;
    font-weight: 500;
    color: #ffffff;
    text-shadow: 0 0 5px rgba(102, 204, 255, 0.5); /* ã»ã‚“ã®ã‚Šå…‰å½©åŠ¹æœ */
}

/* ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’å°‘ã—å°ã•ã */
#lapTimeDisplay {
    font-size: 24px;
    color: #a0a0a0;
    text-shadow: none;
}

/* ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
button {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 18px;
    font-weight: 700; /* å¤ªå­— */
    padding: 12px 24px;
    margin: 10px 5px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    color: #fff;
}

/* ãƒœã‚¿ãƒ³ã«ãƒã‚¦ã‚¹ã‚’ä¹—ã›ãŸæ™‚ã®åŠ¹æœ */
button:hover {
    transform: translateY(-2px); /* å°‘ã—æµ®ãä¸ŠãŒã‚‹ */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

/* ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
button:nth-of-type(1) {
    background-color: #007bff;
}
button:nth-of-type(1):hover {
    background-color: #0056b3;
}

/* ãƒ©ãƒƒãƒ—ãƒœã‚¿ãƒ³ */
button:nth-of-type(2) {
    background-color: #28a745;
}
button:nth-of-type(2):hover {
    background-color: #1e7e34;
}

/* ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ */
button:nth-of-type(3) {
    background-color: #dc3545;
}
button:nth-of-type(3):hover {
    background-color: #b02a37;
}


/* æ°åå…¥åŠ›æ¬„ */
input[type="text"] {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 18px;
    padding: 10px;
    margin-bottom: 20px;
    border: 2px solid #555;
    border-radius: 8px;
    background-color: #333;
    color: #f0f0f0;
    text-align: center;
}
input[type="text"]:focus {
    outline: none;
    border-color: #66ccff;
}

/* å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
#history {
    margin-top: 40px;
}

#history h3 {
    color: #f0f0f0;
}

#historyList {
    font-size: 16px;
    list-style: none;
    padding: 0;
    max-height: 250px; /* é«˜ã•ã‚’å›ºå®šã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
    overflow-y: auto; /* å†…å®¹ãŒå¢—ãˆãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’è¡¨ç¤º */
}

#historyList li {
    background-color: #3a3a3a;
    padding: 12px;
    border-bottom: 1px solid #444;
    transition: background-color 0.2s;
}
/* å¥‡æ•°è¡Œã¨å¶æ•°è¡Œã§è‰²ã‚’å¤‰ãˆã¦è¦‹ã‚„ã™ãã™ã‚‹ */
#historyList li:nth-child(even) {
    background-color: #333;
}

#historyList li:last-child {
    border-bottom: none;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãŠã¾ã‘ï¼‰*/
#historyList::-webkit-scrollbar {
    width: 8px;
}
#historyList::-webkit-scrollbar-track {
    background: #2c2c2c;
}
#historyList::-webkit-scrollbar-thumb {
    background-color: #555;
    border-radius: 4px;
}
  </style>
</head>
<body>
  <div class="stopwatch-container">
   <h2>â± å…±æœ‰ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ</h2>

  <div>
     æ°åï¼š<input type="text" id="name" placeholder="åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
     <span id="userName" style="margin-left: 20px; font-weight: bold;">ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ï¼‰</span>
   </div>
  
   <div class="clock" id="totalTimeDisplay">åˆè¨ˆæ™‚é–“: 00:00:00</div>
   <div class="clock" id="lapTimeDisplay">ãƒ©ãƒƒãƒ—æ™‚é–“: 00:00:00</div>

   <button onclick="startTimer()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
   <button onclick="recordLap()">ãƒ©ãƒƒãƒ—</button>
   <button id="resetBtn" style="display:none" onclick="resetTimer()">å®Œå…¨ãƒªã‚»ãƒƒãƒˆï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰</button>

   <div id="history">
    <h3>ğŸ•˜ ãƒ©ãƒƒãƒ—å±¥æ­´ï¼ˆæœ€æ–°10ä»¶ï¼‰</h3>
    <ul id="historyList"></ul>
  </div>
</div>
    
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbbnoc-rJAQ4l5jA-I-PO9ShhVVQfkmoM",
      authDomain: "stopwatch-app-f8087.firebaseapp.com",
      databaseURL: "https://stopwatch-app-f8087-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "stopwatch-app-f8087",
      storageBucket: "stopwatch-app-f8087.appspot.com",
      messagingSenderId: "162274706963",
      appId: "1:162274706963:web:fa2ea0846da9c54bbce1e6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let timerId = null;
    let startTime = null;
    let lastLapTime = null;
    let lastRemoteLapTime = null;

    const adminEmail = "hase.h.0613@gmail.com";

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
      const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
      const seconds = String(totalSeconds % 60).padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    function updateDisplay() {
      const now = Date.now();
      const totalElapsed = now - startTime;
      const lapElapsed = now - lastLapTime;
      document.getElementById("totalTimeDisplay").textContent = `åˆè¨ˆæ™‚é–“: ${formatTime(totalElapsed)}`;
      document.getElementById("lapTimeDisplay").textContent = `ãƒ©ãƒƒãƒ—æ™‚é–“: ${formatTime(lapElapsed)}`;
    }

    function syncTimer(startMs) {
      startTime = startMs;
      lastLapTime = startMs;
      if (timerId) clearInterval(timerId);
      updateDisplay();
      timerId = setInterval(updateDisplay, 1000);
    }

    function startTimer() {
      const now = Date.now();
      db.ref("control/startTime").set(now);
    }

    function recordLap() {
      const name = document.getElementById("name").value.trim();
      if (!name) {
        alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
        return;
      }

      const now = Date.now();
      const lapTimeFormatted = formatTime(now - lastLapTime);
      const totalTimeFormatted = formatTime(now - startTime);
      lastLapTime = now;

      const lapNumberRef = db.ref("control/lapNumber");

      lapNumberRef.transaction(current => {
        return (current || 0) + 1;
      }, (error, committed, snapshot) => {
        if (committed && snapshot.val() != null) {
          const lapData = {
            name,
            lapTime: lapTimeFormatted,
            totalTime: totalTimeFormatted,
            lapNumber: snapshot.val(),
            timestamp: now
          };
          db.ref("laps").push(lapData);
        } else {
          console.error("ãƒ©ãƒƒãƒ—ç•ªå·ã®æ›´æ–°ã«å¤±æ•—:", error);
        }
      });
    }

    function resetTimer() {
      db.ref("control/startTime").remove();
      db.ref("control/lapNumber").remove();
      db.ref("laps").remove();
      clearInterval(timerId);
      timerId = null;
      startTime = null;
      lastLapTime = null;
      lastRemoteLapTime = null;
      document.getElementById("totalTimeDisplay").textContent = `åˆè¨ˆæ™‚é–“: 00:00:00`;
      document.getElementById("lapTimeDisplay").textContent = `ãƒ©ãƒƒãƒ—æ™‚é–“: 00:00:00`;
      document.getElementById("historyList").innerHTML = "";
    }

    // startTime åŒæœŸ
    db.ref("control/startTime").on("value", (snapshot) => {
      const startMs = snapshot.val();
      if (startMs) {
        syncTimer(startMs);
      } else {
        resetTimer();
      }
    });

    // ãƒ©ãƒƒãƒ—å±¥æ­´
    db.ref("laps").limitToLast(10).on("value", (snapshot) => {
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = "";
      const laps = snapshot.val();
      if (!laps) return;

      const lapArray = Object.values(laps).sort((a, b) => a.timestamp - b.timestamp);
      lapArray.forEach((lap) => {
        const li = document.createElement("li");
        li.textContent = `ãƒ©ãƒƒãƒ— ${lap.lapNumber}ï½œ${lap.name}ï½œãƒ©ãƒƒãƒ—: ${lap.lapTime}ï½œåˆè¨ˆ: ${lap.totalTime}`;
        historyList.appendChild(li);
      });

      const latest = lapArray[lapArray.length - 1];
      if (!lastRemoteLapTime || latest.timestamp > lastRemoteLapTime) {
        lastRemoteLapTime = latest.timestamp;
        lastLapTime = latest.timestamp;
      }
    });

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    firebase.auth().onAuthStateChanged(user => {
      const userNameEl = document.getElementById("userName");
      const resetBtn = document.getElementById("resetBtn");

      if (user) {
        userNameEl.textContent = `ã“ã‚“ã«ã¡ã¯ã€${user.displayName}`;
        resetBtn.style.display = user.email === adminEmail ? "inline-block" : "none";
      } else {
        userNameEl.textContent = "ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ï¼‰";
        resetBtn.style.display = "none";
      }
    });

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³è¡¨ç¤º
    window.onload = () => {
      const btn = document.createElement("button");
      btn.textContent = "Googleã§ãƒ­ã‚°ã‚¤ãƒ³";
      btn.onclick = () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider);
      };
      document.body.insertBefore(btn, document.getElementById("history"));
    };
  </script>
</body>
</html>
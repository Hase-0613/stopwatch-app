<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>共有ストップウォッチ</title>
  <style>
    /* Google Fontsからフォントをインポート */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Roboto+Mono:wght@500&display=swap');

    body {
        /* フォント設定 */
        font-family: 'Noto Sans JP', sans-serif;
        text-align: center;
        
        /* ダークテーマの配色 */
        background-color: #1a1a1a;
        color: #f0f0f0;

        /* スムーズな色の変化 */
        transition: background-color 0.3s, color 0.3s;
        
        /* 上下の余白を調整 */
        margin: 0;
        padding: 40px 15px;
    }

    /* アプリ全体を囲むコンテナ */
    .stopwatch-container {
        max-width: 500px;
        margin: auto;
        background-color: #2c2c2c;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    h2 {
        font-size: 28px;
        color: #66ccff; /* アクセントカラー */
        margin-bottom: 30px;
    }

    .clock {
        font-family: 'Roboto Mono', monospace; /* 数字用の等幅フォント */
        font-size: 48px; /* サイズを大きくして視認性アップ */
        margin: 15px 0;
        letter-spacing: 2px;
        font-weight: 500;
        color: #ffffff;
        text-shadow: 0 0 5px rgba(102, 204, 255, 0.5); /* ほんのり光彩効果 */
    }

    /* ラップタイム表示を少し小さく */
    #lapTimeDisplay {
        font-size: 24px;
        color: #a0a0a0;
        text-shadow: none;
    }

    /* ボタンの共通スタイル */
    button {
        font-family: 'Noto Sans JP', sans-serif;
        font-size: 18px;
        font-weight: 700; /* 太字 */
        padding: 12px 24px;
        margin: 10px 5px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        color: #fff;
    }

    /* ボタンにマウスを乗せた時の効果 */
    button:hover {
        transform: translateY(-2px); /* 少し浮き上がる */
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    /* スタートボタン */
    button:nth-of-type(1) {
        background-color: #007bff;
    }
    button:nth-of-type(1):hover {
        background-color: #0056b3;
    }

    /* ラップボタン */
    button:nth-of-type(2) {
        background-color: #28a745;
    }
    button:nth-of-type(2):hover {
        background-color: #1e7e34;
    }

    /* リセットボタン */
    button:nth-of-type(3) {
        background-color: #dc3545;
    }
    button:nth-of-type(3):hover {
        background-color: #b02a37;
    }


    /* 氏名入力欄 */
    input[type="text"] {
        font-family: 'Noto Sans JP', sans-serif;
        font-size: 18px;
        padding: 10px;
        margin-bottom: 20px;
        border: 2px solid #555;
        border-radius: 8px;
        background-color: #333;
        color: #f0f0f0;
        text-align: center;
    }
    input[type="text"]:focus {
        outline: none;
        border-color: #66ccff;
    }

    /* 履歴セクション */
    #history {
        margin-top: 40px;
    }

    #history h3 {
        color: #f0f0f0;
    }

    #historyList {
        font-size: 16px;
        list-style: none;
        padding: 0;
        max-height: 250px; /* 高さを固定してスクロール可能に */
        overflow-y: auto; /* 内容が増えたらスクロールバーを表示 */
    }

    #historyList li {
        background-color: #3a3a3a;
        padding: 12px;
        border-bottom: 1px solid #444;
        transition: background-color 0.2s;
    }
    /* 奇数行と偶数行で色を変えて見やすくする */
    #historyList li:nth-child(even) {
        background-color: #333;
    }

    #historyList li:last-child {
        border-bottom: none;
    }

    /* スクロールバーのスタイル（おまけ）*/
    #historyList::-webkit-scrollbar {
        width: 8px;
    }
    #historyList::-webkit-scrollbar-track {
        background: #2c2c2c;
    }
    #historyList::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
    }
  </style>
</head>
<body>

  <div class="stopwatch-container">
    <h2>⏱ 共有ストップウォッチ</h2>

    <div>氏名：<input type="text" id="name" placeholder="名前を入力してください"></div>
    <div class="clock" id="totalTimeDisplay">合計時間: 00:00:00</div>
    <div class="clock" id="lapTimeDisplay">ラップ時間: 00:00:00</div>

    <button onclick="startTimer()">スタート</button>
    <button onclick="recordLap()">ラップ</button>
    <button onclick="resetTimer()">完全リセット</button>

    <div id="history">
      <h3>🕘 ラップ履歴（最新10件）</h3>
      <ul id="historyList"></ul>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbbnoc-rJAQ4l5jA-I-PO9ShhVVQfkmoM",
      authDomain: "stopwatch-app-f8087.firebaseapp.com",
      databaseURL: "https://stopwatch-app-f8087-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "stopwatch-app-f8087",
      storageBucket: "stopwatch-app-f8087.appspot.com",
      messagingSenderId: "162274706963",
      appId: "1:162274706963:web:fa2ea0846da9c54bbce1e6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let timerId = null;
    let startTime = null;
    let lastLapTime = null;
    let lastRemoteLapTime = null;

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
      const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
      const seconds = String(totalSeconds % 60).padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    function updateDisplay() {
      const now = Date.now();
      const totalElapsed = now - startTime;
      const lapElapsed = now - lastLapTime;
      document.getElementById("totalTimeDisplay").textContent = `合計時間: ${formatTime(totalElapsed)}`;
      document.getElementById("lapTimeDisplay").textContent = `ラップ時間: ${formatTime(lapElapsed)}`;
    }

    function syncTimer(startMs) {
      startTime = startMs;
      lastLapTime = startMs;
      if (timerId) clearInterval(timerId);
      updateDisplay();
      timerId = setInterval(updateDisplay, 1000);
    }

    function startTimer() {
      const now = Date.now();
      db.ref("control/startTime").set(now);
    }

    function recordLap() {
      const name = document.getElementById("name").value.trim();
      if (!name) {
        alert("名前を入力してください！");
        return;
      }

      const now = Date.now();
      const lapTimeFormatted = formatTime(now - lastLapTime);
      const totalTimeFormatted = formatTime(now - startTime);
      lastLapTime = now;

      const lapNumberRef = db.ref("control/lapNumber");

      lapNumberRef.transaction(current => {
        return (current || 0) + 1;
      }, (error, committed, snapshot) => {
        if (committed && snapshot.val() != null) {
          const lapData = {
            name,
            lapTime: lapTimeFormatted,
            totalTime: totalTimeFormatted,
            lapNumber: snapshot.val(),
            timestamp: now
          };
          db.ref("laps").push(lapData);
        } else {
          console.error("ラップ番号の更新に失敗:", error);
        }
      });
    }

    function resetTimer() {
      db.ref("control/startTime").remove();
      db.ref("control/lapNumber").remove(); // ラップ番号初期化
      db.ref("laps").remove();
      clearInterval(timerId);
      timerId = null;
      startTime = null;
      lastLapTime = null;
      lastRemoteLapTime = null;
      document.getElementById("totalTimeDisplay").textContent = `合計時間: 00:00:00`;
      document.getElementById("lapTimeDisplay").textContent = `ラップ時間: 00:00:00`;
      document.getElementById("historyList").innerHTML = "";
    }

    // タイマー同期
    db.ref("control/startTime").on("value", (snapshot) => {
      const startMs = snapshot.val();
      if (startMs) {
        syncTimer(startMs);
      } else {
        // startTimeがnullならリセット処理（他のブラウザでリセットされた場合）
        if(timerId) resetTimer();
      }
    });

    // ラップ履歴表示＋ラップ時間リセット
    db.ref("laps").limitToLast(10).on("value", (snapshot) => {
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = "";
      const laps = snapshot.val();
      if (!laps) return;

      const lapArray = Object.values(laps).sort((a, b) => b.timestamp - a.timestamp); // 新しい順にソート
      lapArray.forEach((lap) => {
        const li = document.createElement("li");
        li.textContent = `ラップ ${lap.lapNumber}｜${lap.name}｜ラップ: ${lap.lapTime}｜合計: ${lap.totalTime}`;
        historyList.appendChild(li);
      });

      // 最新のラップタイムを同期
      if (lapArray.length > 0) {
          const latest = lapArray[0];
          if (!lastRemoteLapTime || latest.timestamp > lastRemoteLapTime) {
            lastRemoteLapTime = latest.timestamp;
            lastLapTime = latest.timestamp;
          }
      }
    });
  </script>
</body>
</html>